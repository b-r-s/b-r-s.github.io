(function(){"use strict";const R={MOBILITY:2,ADVANCEMENT:1,SUPPORT:2,CENTER_CONTROL:3,BACK_RANK:5},d={REGULAR:10,KING:15},g=(r,o)=>r>=0&&r<8&&o>=0&&o<8,B=(r,o)=>{let t=0;const e=8;for(let n=0;n<e;n++)for(let l=0;l<e;l++){const s=r[n][l];if(s&&s.color===o){const u=[];(s.color==="red"||s.isKing)&&u.push({row:-1,col:-1},{row:-1,col:1}),(s.color==="black"||s.isKing)&&u.push({row:1,col:-1},{row:1,col:1}),u.forEach(c=>{const i=n+c.row,f=l+c.col;g(i,f)&&r[i][f]===null&&t++;const m=n+c.row*2,w=l+c.col*2;if(g(m,w)&&r[m][w]===null){const E=n+c.row,M=l+c.col,a=r[E][M];a&&a.color!==s.color&&t++}})}}return t},A=(r,o)=>{let t=0,e=0,n=0;const l=B(r,o);n+=l*R.MOBILITY;for(let s=0;s<8;s++)for(let u=0;u<8;u++){const c=r[s][u];if(!c||c.color!==o)continue;if(c.isKing?t+=d.KING:t+=d.REGULAR,c.isKing&&(e+=d.KING),!c.isKing){const m=c.color==="red"?7-s:s;n+=m*R.ADVANCEMENT,(c.color==="red"&&s===7||c.color==="black"&&s===0)&&(n+=R.BACK_RANK)}u>=2&&u<=5&&(n+=R.CENTER_CONTROL);const i=c.color==="red"?1:-1,f=s+i;g(f,u-1)&&r[f][u-1]?.color===o&&(n+=R.SUPPORT),g(f,u+1)&&r[f][u+1]?.color===o&&(n+=R.SUPPORT)}return{material:Math.floor(t),power:Math.floor(e),strategy:Math.floor(n),total:Math.floor(t+e+n)}},S=r=>r.row>=0&&r.row<8&&r.col>=0&&r.col<8,C=(r,o,t,e=[])=>{const n=[],l=[];return(o.color==="red"||o.isKing)&&l.push({row:-1,col:-1},{row:-1,col:1}),(o.color==="black"||o.isKing)&&l.push({row:1,col:-1},{row:1,col:1}),l.forEach(s=>{const u=t.row+s.row*2,c=t.col+s.col*2,i={row:u,col:c};if(S(i)&&r[u][c]===null){const f=t.row+s.row,m=t.col+s.col,w={row:f,col:m},E=r[f][m];if(E&&E.color!==o.color&&!e.some(a=>a.row===f&&a.col===m)){const a=r.map(h=>[...h]);a[u][c]=o,a[t.row][t.col]=null,a[f][m]=null;const J=[...e,w],j=C(a,o,i,J);j.length>0?j.forEach(h=>{n.push({from:t,to:h.to,isJump:!0,jumpedPiece:w,jumpSequence:[i,...h.jumpSequence||[]]})}):n.push({from:t,to:i,isJump:!0,jumpedPiece:w,jumpSequence:[i]})}}}),n},K=(r,o,t,e=!0)=>{let n=[];if(e)n=C(r,o,t);else{const u=[];(o.color==="red"||o.isKing)&&u.push({row:-1,col:-1},{row:-1,col:1}),(o.color==="black"||o.isKing)&&u.push({row:1,col:-1},{row:1,col:1}),u.forEach(c=>{const i=t.row+c.row*2,f=t.col+c.col*2,m={row:i,col:f};if(S(m)&&r[i][f]===null){const w=t.row+c.row,E=t.col+c.col,M=r[w][E];M&&M.color!==o.color&&n.push({from:t,to:m,isJump:!0,jumpedPiece:{row:w,col:E},jumpSequence:[m]})}})}if(n.length>0)return n;const l=[],s=[];return(o.color==="red"||o.isKing)&&s.push({row:-1,col:-1},{row:-1,col:1}),(o.color==="black"||o.isKing)&&s.push({row:1,col:-1},{row:1,col:1}),s.forEach(u=>{const c=t.row+u.row,i=t.col+u.col,f={row:c,col:i};S(f)&&r[c][i]===null&&l.push({from:t,to:f,isJump:!1})}),l},O=(r,o)=>{const t=[],e=[];for(let n=0;n<8;n++)for(let l=0;l<8;l++){const s=r[n][l];s&&s.color===o&&K(r,s,{row:n,col:l}).forEach(c=>{c.isJump?e.push(c):t.push(c)})}return e.length>0?e:t},p=(r,o)=>{const t=r.map(n=>[...n]),e={...t[o.from.row][o.from.col]};if(o.isJump&&o.jumpSequence){let n=o.from;for(const l of o.jumpSequence){const s=(n.row+l.row)/2,u=(n.col+l.col)/2;t[s][u]=null,t[l.row][l.col]=e,t[n.row][n.col]=null,n=l}}else t[o.to.row][o.to.col]=e,t[o.from.row][o.from.col]=null,o.isJump&&o.jumpedPiece&&(t[o.jumpedPiece.row][o.jumpedPiece.col]=null);return e.isKing||(e.color==="red"&&o.to.row===0||e.color==="black"&&o.to.row===7)&&(e.isKing=!0),t},P=(r,o)=>{const t=A(r,o),n=A(r,o==="red"?"black":"red");return t.total-n.total},I=(r,o,t,e,n,l)=>{if(o===0)return P(r,l);const u=O(r,n?l:l==="red"?"black":"red");if(u.length===0)return n?-1e4:1e4;const c=[...u].sort((i,f)=>i.isJump&&!f.isJump?-1:!i.isJump&&f.isJump?1:0);if(n){let i=-1/0;for(const f of c){const m=p(r,f),w=I(m,o-1,t,e,!1,l);if(i=Math.max(i,w),t=Math.max(t,w),e<=t)break}return i}else{let i=1/0;for(const f of c){const m=p(r,f),w=I(m,o-1,t,e,!0,l);if(i=Math.min(i,w),e=Math.min(e,w),e<=t)break}return i}},_=(r,o,t="intermediate")=>{const e=O(r,o);if(e.length===0)return null;if(t==="beginner")return e[Math.floor(Math.random()*e.length)];if(t==="intermediate"){let n=null,l=-1/0;for(const s of e){const u=p(r,s),c=I(u,1,-1/0,1/0,!1,o);c>l&&(l=c,n=s)}return n||e[0]}if(t==="advanced"){let n=null,l=-1/0,s=5;const u=[...e].sort((c,i)=>{if(c.isJump&&!i.isJump)return-1;if(!c.isJump&&i.isJump)return 1;const f=!r[c.from.row][c.from.col]?.isKing&&(c.to.row===0||c.to.row===7),m=!r[i.from.row][i.from.col]?.isKing&&(i.to.row===0||i.to.row===7);return f&&!m?-1:!f&&m?1:0});for(const c of u){const i=performance.now(),f=p(r,c),m=I(f,s,-1/0,1/0,!1,o);performance.now()-i>200&&s>3&&s--,m>l&&(l=m,n=c)}return n||e[0]}return e[Math.floor(Math.random()*e.length)]};self.onmessage=r=>{const{board:o,player:t,difficulty:e}=r.data;try{const n=_(o,t,e);self.postMessage({bestMove:n})}catch(n){self.postMessage({error:n.message})}}})();
